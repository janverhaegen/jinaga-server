!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=3)}([function(e,t){e.exports=require("jinaga")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};function o(e){var t=e.reduce((function(e,t){return e&&0!==e.length?t&&0!==t.length?e.concat(t):e:t}));return t||[]}Object.defineProperty(t,"__esModule",{value:!0}),t.distinct=t.findIndex=t.filterAsync=t.mapAsync=t.flatten=t.flattenAsync=void 0,t.flattenAsync=function(e,t){return r(this,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return 0!==e.length?[3,1]:[2,[]];case 1:return[4,Promise.all(e.map(t))];case 2:return[2,o(n.sent())]}}))}))},t.flatten=function(e,t){return 0===e.length?[]:o(e.map(t))},t.mapAsync=function(e,t){return r(this,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return 0!==e.length?[3,1]:[2,[]];case 1:return[4,Promise.all(e.map(t))];case 2:return[2,n.sent()]}}))}))},t.filterAsync=function(e,t){return r(this,void 0,void 0,(function(){var n=this;return i(this,(function(o){switch(o.label){case 0:return 0!==e.length?[3,1]:[2,[]];case 1:return[4,Promise.all(e.map((function(e){return r(n,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return n={},[4,t(e)];case 1:return[2,(n.include=r.sent(),n.element=e,n)]}}))}))})))];case 2:return[2,o.sent().filter((function(e){return e.include})).map((function(e){return e.element}))]}}))}))},t.findIndex=function(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return n;return-1},t.distinct=function(e,t,n){return n.indexOf(e)===t}},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionFactory=void 0;var o=n(16),s=function(){function e(e){this.postgresPool=new o.Pool({connectionString:e})}return e.prototype.withTransaction=function(e){var t=this;return this.with((function(n){return r(t,void 0,void 0,(function(){var t,r;return i(this,(function(i){switch(i.label){case 0:return i.trys.push([0,4,,6]),[4,n.query("BEGIN")];case 1:return i.sent(),[4,e(n)];case 2:return t=i.sent(),[4,n.query("COMMIT")];case 3:return i.sent(),[2,t];case 4:return r=i.sent(),[4,n.query("ROLLBACK")];case 5:throw i.sent(),r;case 6:return[2]}}))}))}))},e.prototype.with=function(e){return r(this,void 0,void 0,(function(){var t;return i(this,(function(n){switch(n.label){case 0:return[4,this.createClient()];case 1:t=n.sent(),n.label=2;case 2:return n.trys.push([2,,4,5]),[4,e(t)];case 3:return[2,n.sent()];case 4:return t.release(),[7];case 5:return[2]}}))}))},e.prototype.createClient=function(){return r(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this.postgresPool.connect()];case 1:return[2,e.sent()]}}))}))},e}();t.ConnectionFactory=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4);Object.defineProperty(t,"JinagaServer",{enumerable:!0,get:function(){return r.JinagaServer}})},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.JinagaServer=void 0;var o=n(0),s=n(5),a=n(6),u=n(7),c=n(8),l=n(12),h=n(14),f=n(17),p={provider:"jinaga",id:"local"},d=function(){function e(){}return e.create=function(e){var t=new o.SyncStatusNotifier,n=function(e){if(e.pgStore){var t=new f.PostgresStore(e.pgStore);return new o.Cache(t)}return new o.MemoryStore}(e),d=new o.FeedImpl(n),y=function(e,t,n){if(e.httpEndpoint){var r=new c.NodeHttpConnection(e.httpEndpoint),i=e.httpTimeoutSeconds||5,s=new o.WebClient(r,n,{timeoutSeconds:i});return new o.TransientFork(t,s)}return t}(e,d,t),v=function(e,t){if(e.pgKeystore){var n=new h.PostgresKeystore(e.pgKeystore),r=e.authorization?e.authorization(new o.AuthorizationRules):null;return new u.AuthorizationKeystore(t,n,r)}return new o.AuthorizationNoOp(t)}(e,y),b=new l.HttpRouter(v),w=new h.PostgresKeystore(e.pgKeystore),g=new s.AuthenticationDevice(y,w,p),m=new o.MemoryStore,S=new o.Jinaga(g,m,t);return{handler:b.handler,j:S,withSession:function(e,t){return function(e,t,n,s){return r(this,void 0,void 0,(function(){var r,u,c,l,h;return i(this,(function(i){switch(i.label){case 0:return r=n.user,u={provider:r.provider,id:r.id},c=new a.AuthenticationSession(e,t,u,r.profile.displayName,p),l=new o.SyncStatusNotifier,h=new o.Jinaga(c,new o.MemoryStore,l),[4,s(h)];case 1:return i.sent(),[2]}}))}))}(d,w,e,t)}}},e}();t.JinagaServer=d},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.AuthenticationDevice=void 0;var o=function(){function e(e,t,n){this.inner=e,this.keystore=t,this.localDeviceIdentity=n}return e.prototype.login=function(){return r(this,void 0,void 0,(function(){return i(this,(function(e){throw new Error("No logged in user.")}))}))},e.prototype.local=function(){return r(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this.keystore.getDeviceFact(this.localDeviceIdentity)];case 1:return[2,e.sent()]}}))}))},e.prototype.from=function(e,t){return this.inner.from(e,t)},e.prototype.save=function(e){return this.inner.save(e)},e.prototype.query=function(e,t){return this.inner.query(e,t)},e.prototype.exists=function(e){throw new Error("Exists method not implemented on AuthenticationDevice.")},e.prototype.load=function(e){return this.inner.load(e)},e}();t.AuthenticationDevice=o},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.AuthenticationSession=void 0;var o=function(){function e(e,t,n,r,i){this.inner=e,this.keystore=t,this.userIdentity=n,this.displayName=r,this.localDeviceIdentity=i}return e.prototype.login=function(){return r(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this.keystore.getUserFact(this.userIdentity)];case 1:return[2,{userFact:e.sent(),profile:{displayName:this.displayName}}]}}))}))},e.prototype.local=function(){return r(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this.keystore.getDeviceFact(this.localDeviceIdentity)];case 1:return[2,e.sent()]}}))}))},e.prototype.from=function(e,t){return this.inner.from(e,t)},e.prototype.save=function(e){return this.inner.save(e)},e.prototype.query=function(e,t){return this.inner.query(e,t)},e.prototype.exists=function(e){throw new Error("Exists method not implemented on AuthenticationSession.")},e.prototype.load=function(e){return this.inner.load(e)},e}();t.AuthenticationSession=o},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.AuthorizationKeystore=void 0;var o=n(1),s=n(0),a=function(){function e(e,t,n){this.feed=e,this.keystore=t,this.authorizationEngine=n&&new s.AuthorizationEngine(n,e)}return e.prototype.getUserFact=function(e){return r(this,void 0,void 0,(function(){var t,n;return i(this,(function(r){switch(r.label){case 0:return[4,this.keystore.getUserFact(e)];case 1:return t=r.sent(),n=[{fact:t,signatures:[]}],[4,this.feed.save(n)];case 2:return r.sent(),[2,t]}}))}))},e.prototype.query=function(e,t,n){return this.feed.query(t,n)},e.prototype.load=function(e,t){return this.feed.load(t)},e.prototype.save=function(e,t){return r(this,void 0,void 0,(function(){var n,s,a,u=this;return i(this,(function(c){switch(c.label){case 0:return this.authorizationEngine?[3,2]:[4,this.feed.save(t.map((function(e){return{fact:e,signatures:[]}})))];case 1:return[2,c.sent().map((function(e){return e.fact}))];case 2:return[4,this.keystore.getUserFact(e)];case 3:return n=c.sent(),[4,this.authorizationEngine.authorizeFacts(t,n)];case 4:return s=c.sent(),[4,o.mapAsync(s,(function(t){return r(u,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return n={fact:t},[4,this.keystore.signFact(e,t)];case 1:return[2,(n.signatures=r.sent(),n)]}}))}))}))];case 5:return a=c.sent(),[4,this.feed.save(a)];case 6:return[2,c.sent().map((function(e){return e.fact}))]}}))}))},e}();t.AuthorizationKeystore=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NodeHttpConnection=void 0;var r=n(9),i=n(10),o=n(11),s=function(){function e(e){this.url=e}return e.prototype.get=function(e){var t=this;return new Promise((function(n,s){var a="https:"===o.parse(t.url+e).protocol?i.get:r.get,u="";a(t.url+e,(function(e){e.on("data",(function(e){u+=e})),e.on("end",(function(){try{var e=JSON.parse(u);n(e)}catch(e){s(e)}}))})).on("error",(function(e){return s(e)}))}))},e.prototype.post=function(e,t,n){var s=this;return new Promise((function(a,u){var c=o.parse(s.url+e),l=c.protocol,h=c.host,f=c.port,p=c.path,d="https:"===l?i.request:r.request,y="",v=d({method:"POST",host:h,port:f,path:p,headers:{Accept:"application/json","Content-Type":"application/json"},timeout:1e3*n},(function(e){e.on("data",(function(e){e instanceof Buffer?y+=e.toString():y+=e})),e.on("error",(function(e){a({result:"failure",error:e.message})})),e.on("end",(function(){if(403===e.statusCode)u(y);else if(e.statusCode>=400)a({result:"retry",error:y});else if(e.headers["content-type"].split(";").indexOf("application/json")>=0)try{var t=JSON.parse(y);a({result:"success",response:t})}catch(e){u(e)}else u(y)}))}));v.on("error",(function(e){a({result:"failure",error:e.message})})),v.write(JSON.stringify(t)),v.end()}))},e}();t.NodeHttpConnection=s},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("url")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.HttpRouter=void 0;var o=n(13),s=n(0),a=n(0),u=n(0);function c(e){return function(t,n,r){var i=t.user,o=t.body;if(!o)throw new Error("Ensure that you have installed body-parser and called app.use(bodyParser.json()).");e(i,o).then((function(e){n.setHeader("Content-Type","application/json"),n.send(JSON.stringify(e)),r()})).catch((function(e){e instanceof s.Forbidden?(u.Trace.warn(e.message),n.status(403).send(e.message)):(u.Trace.error(e),n.sendStatus(500)),r()}))}}function l(e){return e?{provider:e.provider,id:e.id}:null}var h=function(){function e(e){var t=this;this.authorization=e;var n,r=o.Router();r.get("/login",(n=function(e){return t.login(e)},function(e,t,r){var i=e.user;i?n(i).then((function(e){t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(e)),r()})).catch((function(e){u.Trace.error(e),t.sendStatus(500),r()})):t.sendStatus(401)})),r.post("/query",c((function(e,n){return t.query(e,n)}))),r.post("/load",c((function(e,n){return t.load(e,n)}))),r.post("/save",c((function(e,n){return t.save(e,n)}))),this.handler=r}return e.prototype.login=function(e){return r(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this.authorization.getUserFact({provider:e.provider,id:e.id})];case 1:return[2,{userFact:t.sent(),profile:e.profile}]}}))}))},e.prototype.query=function(e,t){return r(this,void 0,void 0,(function(){var n,r;return i(this,(function(i){switch(i.label){case 0:return n=l(e),r=a.fromDescriptiveString(t.query),[4,this.authorization.query(n,t.start,r)];case 1:return[2,{results:i.sent()}]}}))}))},e.prototype.load=function(e,t){return r(this,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return n=l(e),[4,this.authorization.load(n,t.references)];case 1:return[2,{facts:r.sent()}]}}))}))},e.prototype.save=function(e,t){return r(this,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return n=l(e),[4,this.authorization.save(n,t.facts)];case 1:return r.sent(),[2,{}]}}))}))},e}();t.HttpRouter=h},function(e,t){e.exports=require("express")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.PostgresKeystore=void 0;var o=n(15),s=n(0),a=n(0),u=n(2),c=function(){function e(e){this.connectionFactory=new u.ConnectionFactory(e)}return e.prototype.getUserFact=function(e){return this.getIdentityFact("Jinaga.User",e)},e.prototype.getDeviceFact=function(e){return this.getIdentityFact("Jinaga.Device",e)},e.prototype.signFact=function(e,t){return r(this,void 0,void 0,(function(){var n=this;return i(this,(function(u){switch(u.label){case 0:return e?[4,this.connectionFactory.withTransaction((function(u){return r(n,void 0,void 0,(function(){var n,r,c,l,h,f,p,d,y,v;return i(this,(function(i){switch(i.label){case 0:return[4,this.getPrivateKey(u,e)];case 1:return n=i.sent(),r=n.publicKey,c=n.privateKey,l=o.pki.privateKeyFromPem(c),h=s.canonicalizeFact(t.fields,t.predecessors),f=o.util.encodeUtf8(h),p=o.md.sha512.create().update(f),d=o.util.encode64(p.digest().getBytes()),t.hash!==d?(a.Trace.error('Hash does not match. "'+t.hash+'" !== "'+d+'"\nFact: '+h),[2,[]]):(y=o.util.encode64(l.sign(p)),v=o.pki.publicKeyFromPem(r),v.verify(p.digest().getBytes(),o.util.decode64(y))?[2,[{signature:y,publicKey:r}]]:(a.Trace.error("The signature did not verify correctly.\nHash: "+d+"\nSignature: "+y+"\nFact: "+h+"\n"+r),[2,[]]))}}))}))}))]:[2,[]];case 1:return[2,u.sent()]}}))}))},e.prototype.getIdentityFact=function(e,t){var n=this;return t?this.connectionFactory.withTransaction((function(o){return r(n,void 0,void 0,(function(){var n,r,a,u;return i(this,(function(i){switch(i.label){case 0:return[4,this.getPublicKey(o,t)];case 1:return n=i.sent(),r={},a={publicKey:n},u=s.computeHash(a,r),[2,{type:e,hash:u,predecessors:r,fields:a}]}}))}))})):null},e.prototype.getPublicKey=function(e,t){return r(this,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return[4,e.query("SELECT public_key FROM public.user WHERE provider = $1 AND user_id = $2",[t.provider,t.id])];case 1:if((n=r.sent().rows).length>1)throw new Error("Duplicate entries found in the keystore");return 1===n.length?[2,n[0].public_key]:[2,this.generateKeyPair(e,t)]}}))}))},e.prototype.getPrivateKey=function(e,t){return r(this,void 0,void 0,(function(){var n,r,o;return i(this,(function(i){switch(i.label){case 0:return[4,e.query("SELECT public_key, private_key FROM public.user WHERE provider = $1 AND user_id = $2",[t.provider,t.id])];case 1:if((n=i.sent().rows).length>1)throw new Error("Duplicate entries found in the keystore");if(1===n.length)return r=n[0].public_key,o=n[0].private_key,[2,{publicKey:r,privateKey:o}];throw new Error("No entry found in the keystore")}}))}))},e.prototype.generateKeyPair=function(e,t){return r(this,void 0,void 0,(function(){var n,r,s;return i(this,(function(i){switch(i.label){case 0:return n=o.pki.rsa.generateKeyPair({bits:2048}),r=o.pki.privateKeyToPem(n.privateKey),s=o.pki.publicKeyToPem(n.publicKey),[4,e.query("INSERT INTO public.user (provider, user_id, private_key, public_key) VALUES ($1, $2, $3, $4)",[t.provider,t.id,r,s])];case 1:return i.sent(),[2,s]}}))}))},e}();t.PostgresKeystore=c},function(e,t){e.exports=require("node-forge")},function(e,t){e.exports=require("pg")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.PostgresStore=void 0;var o=n(0),s=n(1),a=n(2),u=n(18),c=n(19);function l(e){return{type:e.type,hash:e.hash,predecessors:JSON.parse(e.predecessors),fields:JSON.parse(e.fields)}}function h(e){return{type:e.type,hash:e.hash}}var f=function(){function e(e){this.connectionFactory=new a.ConnectionFactory(e)}return e.prototype.save=function(e){return r(this,void 0,void 0,(function(){var t,n=this;return i(this,(function(s){switch(s.label){case 0:if(!(e.length>0))return[3,2];if((t=e.map((function(e){return e.fact}))).some((function(e){return!e.hash||!e.type})))throw new Error("Attempted to save a fact with no hash or type.");return[4,this.connectionFactory.withTransaction((function(s){return r(n,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return[4,p(t,s)];case 1:return[4,d(n=r.sent(),s)];case 2:return r.sent(),[4,y(n,s)];case 3:return r.sent(),[4,v(e,s)];case 4:return r.sent(),[2,e.filter((function(e){return n.some(o.factReferenceEquals(e.fact))}))]}}))}))}))];case 1:return[2,s.sent()];case 2:return[2,[]]}}))}))},e.prototype.query=function(e,t){return r(this,void 0,void 0,(function(){var n,o=this;return i(this,(function(s){switch(s.label){case 0:if(0===t.steps.length)return[2,[[e]]];if(!(n=c.sqlFromSteps(e,t.steps)))throw new Error('Could not generate SQL for query "'+t.toDescriptiveString()+'"');return[4,this.connectionFactory.with((function(e){return r(o,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,e.query(n.sql,n.parameters)];case 1:return[2,t.sent()]}}))}))}))];case 1:return[2,s.sent().rows.map((function(e){return function(e,t){for(var n=[],r=0;r<e;r++)n.push({type:t["type"+r],hash:t["hash"+r]});return n}(n.pathLength,e)}))]}}))}))},e.prototype.exists=function(e){return r(this,void 0,void 0,(function(){var t,n=this;return i(this,(function(o){switch(o.label){case 0:return"SELECT COUNT(1) AS count FROM public.fact WHERE type=$1 AND hash=$2",t=[e.type,e.hash],[4,this.connectionFactory.with((function(e){return r(n,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,e.query("SELECT COUNT(1) AS count FROM public.fact WHERE type=$1 AND hash=$2",t)];case 1:return[2,n.sent()]}}))}))}))];case 1:return[2,o.sent().rows[0].count>0]}}))}))},e.prototype.load=function(e){return r(this,void 0,void 0,(function(){var t,n,o,a=this;return i(this,(function(u){switch(u.label){case 0:return 0===e.length?[2,[]]:(t=e.map((function(e,t){return"($"+(2*t+1)+", $"+(2*t+2)+")"})),n=s.flatten(e,(function(e){return[e.type,e.hash]})),o="WITH RECURSIVE a(ancestor_hash, ancestor_type, hash, type) AS ( SELECT v.hash AS ancestor_hash, v.type AS ancestor_type, v.hash, v.type FROM (VALUES "+t.join(", ")+") AS v (type, hash) UNION ALL SELECT e.predecessor_hash AS ancestor_hash, e.predecessor_type AS ancestor_type, a.hash, a.type FROM a JOIN public.edge e ON e.successor_hash = a.ancestor_hash AND e.successor_type = a.ancestor_type) SELECT fact.type, fact.hash, fact.fields, fact.predecessors FROM (SELECT DISTINCT a.ancestor_hash, a.ancestor_type FROM a) AS d JOIN public.fact ON d.ancestor_type = fact.type AND d.ancestor_hash = fact.hash;",[4,this.connectionFactory.with((function(e){return r(a,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,e.query(o,n)];case 1:return[2,t.sent()]}}))}))}))]);case 1:return[2,u.sent().rows.map(l)]}}))}))},e}();function p(e,t){return r(this,void 0,void 0,(function(){var n,r,a,u;return i(this,(function(i){switch(i.label){case 0:return e.length>0?(n=e.map((function(e,t){return"($"+(2*t+1)+", $"+(2*t+2)+")"})),r=s.flatten(e,(function(e){return[e.hash,e.type]})),[4,t.query("SELECT hash, type  FROM (VALUES "+n.join(", ")+") AS v(hash, type)  WHERE NOT EXISTS (SELECT 1 FROM public.fact   WHERE fact.hash = v.hash AND fact.type = v.type)",r)]):[3,2];case 1:return a=i.sent().rows,u=a.map(h),[2,e.filter((function(e){return u.some(o.factReferenceEquals(e))}))];case 2:return[2,[]]}}))}))}function d(e,t){return r(this,void 0,void 0,(function(){var n,r,o;return i(this,(function(i){switch(i.label){case 0:return(n=s.flatten(e,u.makeEdgeRecords)).length>0?(r=n.map((function(e,t){return"($"+(5*t+1)+", $"+(5*t+2)+", $"+(5*t+3)+", $"+(5*t+4)+", $"+(5*t+5)+")"})),o=s.flatten(n,(function(e){return[e.predecessor_hash,e.predecessor_type,e.successor_hash,e.successor_type,e.role]})),[4,t.query("INSERT INTO public.edge (predecessor_hash, predecessor_type, successor_hash, successor_type, role) (VALUES "+r.join(", ")+") ON CONFLICT DO NOTHING",o)]):[3,2];case 1:i.sent(),i.label=2;case 2:return[2]}}))}))}function y(e,t){return r(this,void 0,void 0,(function(){var n,r;return i(this,(function(i){switch(i.label){case 0:return e.length>0?(n=e.map((function(e,t){return"($"+(4*t+1)+", $"+(4*t+2)+", $"+(4*t+3)+", $"+(4*t+4)+")"})),r=s.flatten(e,(function(e){return[e.hash,e.type,JSON.stringify(e.fields),JSON.stringify(e.predecessors)]})),[4,t.query("INSERT INTO public.fact (hash, type, fields, predecessors) (SELECT hash, type, to_jsonb(fields), to_jsonb(predecessors)  FROM (VALUES "+n.join(", ")+") AS v(hash, type, fields, predecessors)) ON CONFLICT DO NOTHING",r)]):[3,2];case 1:i.sent(),i.label=2;case 2:return[2]}}))}))}function v(e,t){return r(this,void 0,void 0,(function(){var n,r,o;return i(this,(function(i){switch(i.label){case 0:return(n=s.flatten(e,(function(e){return e.signatures.map((function(t){return{type:e.fact.type,hash:e.fact.hash,publicKey:t.publicKey,signature:t.signature}}))}))).length>0?(r=n.map((function(e,t){return"($"+(4*t+1)+", $"+(4*t+2)+", $"+(4*t+3)+", $"+(4*t+4)+")"})),o=s.flatten(n,(function(e){return[e.hash,e.type,e.publicKey,e.signature]})),[4,t.query("INSERT INTO public.signature\n            (hash, type, public_key, signature) \n            (SELECT hash, type, public_key, signature \n            FROM (VALUES "+r.join(", ")+") AS v(hash, type, public_key, signature) \n            WHERE NOT EXISTS (SELECT 1 FROM public.signature \n            WHERE signature.hash = v.hash AND signature.type = v.type AND signature.public_key = v.public_key))\n            ON CONFLICT DO NOTHING",o)]):[3,2];case 1:i.sent(),i.label=2;case 2:return[2]}}))}))}t.PostgresStore=f},function(e,t,n){"use strict";function r(e,t,n){if(!(e.hash&&e.type&&t.hash&&t.type))throw new Error("Attempting to save edge with null hash or type.");return{predecessor_hash:e.hash,predecessor_type:e.type,successor_hash:t.hash,successor_type:t.type,role:n}}Object.defineProperty(t,"__esModule",{value:!0}),t.makeEdgeRecords=void 0,t.makeEdgeRecords=function(e){var t=[],n=function(n){var i=e.predecessors[n];Array.isArray(i)?t=t.concat(i.map((function(t){return r(t,e,n)}))):t.push(r(i,e,n))};for(var i in e.predecessors)n(i);return t}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sqlFromSteps=void 0;var r=n(0);t.sqlFromSteps=function(e,t){return(new i).buildQuery(e,t)};var i=function(){function e(){this.parameters=[],this.nextAlias=1}return e.prototype.buildQuery=function(e,t){var n=t.reduce((function(e,t){return e.transition(t)}),this.stateStart(e));return n.parts?{sql:this.assembleQueryString(n.parts),parameters:this.parameters,pathLength:n.parts.prefixes.length}:null},e.prototype.assembleQueryString=function(e){return"SELECT "+e.prefixes.map((function(e,t){return e+"type AS type"+t+", "+e+"hash AS hash"+t})).join(", ")+" "+e.fromClause+" "+e.joins+" WHERE "+e.whereClause},e.prototype.buildChildQuery=function(e,t){var n=t.reduce((function(e,t){return e.transition(t)}),this.stateSubquery(e));return this.assembleChildQueryString(n.parts)},e.prototype.assembleChildQueryString=function(e){return"SELECT 1 "+e.fromClause+" "+e.joins+" WHERE "+e.whereClause},e.prototype.stateStart=function(e){var t=this;return{parts:null,transition:function(n){return t.transitionFromStart(e,n)}}},e.prototype.transitionFromStart=function(e,t){if(t instanceof r.Join){if(t.direction===r.Direction.Successor)return this.handleStartSuccessor(e,t.role);if(t.direction===r.Direction.Predecessor)return this.handleStartPredecessor(e,t.role)}else if(t instanceof r.PropertyCondition&&"type"===t.name)return this.handleStartType(e,t.value);throw new Error("Cannot yet handle this query: "+t.toDeclarativeString())},e.prototype.handleStartSuccessor=function(e,t){var n=this.allocateAlias(),r={prefixes:[n+".successor_"],fromClause:"FROM public.edge "+n,joins:"",whereClause:n+".predecessor_type = "+this.addParameter(e.type)+" AND "+n+".predecessor_hash = "+this.addParameter(e.hash)+" AND "+n+".role = "+this.addParameter(t)};return this.stateMatched(r)},e.prototype.handleStartPredecessor=function(e,t){var n=this.allocateAlias(),r={prefixes:[n+".predecessor_"],fromClause:"FROM public.edge "+n,joins:"",whereClause:n+".successor_type = "+this.addParameter(e.type)+" AND "+n+".successor_hash = "+this.addParameter(e.hash)+" AND "+n+".role = "+this.addParameter(t)};return this.stateMatched(r)},e.prototype.handleStartType=function(e,t){if(t===e.type)return this.stateStart(e);throw new Error("Type does not match: "+e.type+" != "+t)},e.prototype.stateSubquery=function(e){var t=this;return{parts:null,transition:function(n){return t.transitionFromSubquery(e,n)}}},e.prototype.transitionFromSubquery=function(e,t){if(t instanceof r.Join){if(t.direction===r.Direction.Successor)return this.handleSubquerySuccessor(e,t.role);if(t.direction===r.Direction.Predecessor)return this.handleSubqueryPredecessor(e,t.role)}throw new Error("Cannot yet handle this query: "+t.toDeclarativeString())},e.prototype.handleSubquerySuccessor=function(e,t){var n=this.allocateAlias(),r={prefixes:[n+".successor_"],fromClause:"FROM public.edge "+n,joins:"",whereClause:n+".predecessor_type = "+e+"type AND "+n+".predecessor_hash = "+e+"hash AND "+n+".role = "+this.addParameter(t)};return this.stateMatched(r)},e.prototype.handleSubqueryPredecessor=function(e,t){var n=this.allocateAlias(),r={prefixes:[n+".predecessor_"],fromClause:"FROM public.edge "+n,joins:"",whereClause:n+".successor_type = "+e+"type AND "+n+".successor_hash = "+e+"hash AND "+n+".role = "+this.addParameter(t)};return this.stateMatched(r)},e.prototype.stateMatched=function(e){var t=this;return{parts:e,transition:function(n){return t.transitionFromMatched(e,n)}}},e.prototype.transitionFromMatched=function(e,t){if(t instanceof r.PropertyCondition&&"type"===t.name)return this.handleMatchedType(e,t.value);if(t instanceof r.Join){if(t.direction===r.Direction.Successor)return this.handleMatchedSuccessor(e,t.role);if(t.direction===r.Direction.Predecessor)return this.handleMatchedPredecessor(e,t.role)}else if(t instanceof r.ExistentialCondition)return this.handleMatchedExistentialCondition(e,t.quantifier,t.steps);throw new Error("Cannot yet handle this query: "+t.toDeclarativeString())},e.prototype.handleMatchedType=function(e,t){var n=e.prefixes[e.prefixes.length-1],r=e.whereClause+" AND "+n+"type = "+this.addParameter(t);return this.stateMatched({prefixes:e.prefixes,fromClause:e.fromClause,joins:e.joins,whereClause:r})},e.prototype.handleMatchedSuccessor=function(e,t){var n=this.addParameter(t),r=e.prefixes[e.prefixes.length-1],i=this.allocateAlias(),o=e.joins+" JOIN public.edge "+i+" ON "+i+".predecessor_hash = "+r+"hash AND "+i+".predecessor_type = "+r+"type",s=e.whereClause+" AND "+i+".role = "+n,a=e.prefixes.concat([i+".successor_"]);return this.stateMatched({prefixes:a,fromClause:e.fromClause,joins:o,whereClause:s})},e.prototype.handleMatchedPredecessor=function(e,t){var n=this.addParameter(t),r=e.prefixes[e.prefixes.length-1],i=this.allocateAlias(),o=e.joins+" JOIN public.edge "+i+" ON "+i+".successor_hash = "+r+"hash AND "+i+".successor_type = "+r+"type",s=e.whereClause+" AND "+i+".role = "+n,a=e.prefixes.concat([i+".predecessor_"]);return this.stateMatched({prefixes:a,fromClause:e.fromClause,joins:o,whereClause:s})},e.prototype.handleMatchedExistentialCondition=function(e,t,n){var i=t===r.Quantifier.Exists?"EXISTS":"NOT EXISTS",o=e.prefixes[e.prefixes.length-1],s=this.buildChildQuery(o,n),a=e.whereClause+" AND "+i+" ("+s+")";return this.stateMatched({prefixes:e.prefixes,fromClause:e.fromClause,joins:e.joins,whereClause:a})},e.prototype.allocateAlias=function(){return"e"+this.nextAlias++},e.prototype.addParameter=function(e){return this.parameters.push(e),"$"+this.parameters.length},e}()}]));
//# sourceMappingURL=index.js.map